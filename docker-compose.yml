version: '3.8'

services:
  # Cortex Gateway Service (Node.js/TypeScript)
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cortex-gateway
    environment:
      HOME: /home/node
      TERM: xterm-256color
      NODE_ENV: ${NODE_ENV:-development}
      CORTEX_GATEWAY_TOKEN: ${CORTEX_GATEWAY_TOKEN}
      FASTEMBED_URL: http://fastembed:8000
    volumes:
      - ${CORTEX_CONFIG_DIR:-./data/config}:/home/node/.cortex
      - ${CORTEX_WORKSPACE_DIR:-./data/workspace}:/home/node/.cortex/workspace
    ports:
      - "${CORTEX_GATEWAY_PORT:-18789}:18789"
    networks:
      - cortex
    depends_on:
      - fastembed
    restart: unless-stopped
    init: true

  # FastEmbed Service (Python)
  fastembed:
    build:
      context: ./services/fastembed
      dockerfile: Dockerfile
    container_name: cortex-fastembed
    environment:
      PYTHONUNBUFFERED: 1
    ports:
      - "${FASTEMBED_PORT:-8000}:8000"
    networks:
      - cortex
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  cortex:
    name: cortex
    driver: bridge

